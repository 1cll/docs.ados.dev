# SRE エージェント

SRE エージェントは本番環境のメトリクスを監視し、異常を検知すると自動で調査・修復を行います。

## 概要

```
┌──────────────┐     ┌───────────────┐     ┌──────────────┐     ┌──────────────┐
│  メトリクス    │ ──▶ │  異常検知      │ ──▶ │  原因調査      │ ──▶ │  修復 PR     │
│  (GCP Logs)  │     │  (閾値超過)    │     │  (AI 分析)    │     │  (自動作成)  │
└──────────────┘     └───────────────┘     └──────────────┘     └──────────────┘
```

## 有効化

```yaml
repos:
  - name: my-repo
    workers:
      sre_agent:
        enabled: true
        gcloud_projects:
          - my-gcp-project-id
        error_threshold: 10        # エラー率の閾値（/分）
        latency_threshold_ms: 5000 # レイテンシの閾値（ミリ秒）
        check_interval: 5m         # チェック間隔
        cooldown_duration: 1h      # 同一アラートの再発防止期間
```

## 監視項目

### エラーレート
- アプリケーションのエラーログ頻度を監視
- `error_threshold` を超えた場合にアラート

### レイテンシ
- API レスポンスタイムを監視
- `latency_threshold_ms` を超えた場合にアラート

### リソース
- メモリ使用量（OOM Kill の検知）
- CPU 使用率
- ディスク使用量

### アプリケーションログ
- GCP Cloud Logging からログを取得
- スタックトレースの自動解析
- パターンマッチによる異常検知

## GCP 連携

現在、SRE エージェントは **Google Cloud Platform** の以下のサービスと連携します：

| サービス | 用途 |
|---------|------|
| **Cloud Logging** | アプリケーションログの取得 |
| **Cloud Monitoring** | メトリクスの取得 |
| **Cloud Run** | コンテナ環境の監視 |

### 認証設定

```bash
# 環境変数で GCP プロジェクトを設定
export GCP_PROJECT=my-project-id
export GOOGLE_CLOUD_PROJECT=my-project-id
```

> [!NOTE]
> AWS / Azure 対応は今後のロードマップに含まれています。

## 自動修復の例

### 1. エラーレートのスパイク

```
検知: /api/users でエラー率が 50/分 を超過
分析: NullPointerException が db.query() で発生
原因: 新しいデプロイでデータベース接続のNull チェックが漏れていた
修復: Null チェックを追加した PR を自動作成
```

### 2. メモリリーク (OOM)

```
検知: コンテナが OOM Kill で再起動
分析: ログから大量のオブジェクト生成パターンを特定
原因: キャッシュのサイズ制限がなかった
修復: LRU キャッシュの上限を設定する PR を自動作成
```

### 3. レイテンシ悪化

```
検知: /api/search のレイテンシが 5000ms を超過
分析: 新しいクエリにインデックスが効いていない
原因: 新規カラムへのクエリ追加時にインデックスが未作成
修復: インデックス追加のマイグレーション PR を自動作成
```

## アラート通知

SRE エージェントのアラートは通知システムと連携できます：

- **Slack** — チャンネルに即時通知
- **Discord** — Webhook で通知
- **メール** — アラートメール送信

詳細は [通知設定](guides/notifications.md) を参照してください。

## Pro プラン以上の機能

SRE エージェントは **Pro プラン以上** でご利用いただけます。

| プラン | SRE エージェント |
|--------|----------------|
| Free | ❌ |
| Pro | ✅ |
| Team | ✅ |
