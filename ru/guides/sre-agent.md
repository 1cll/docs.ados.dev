# SRE-агент

SRE-агент мониторит метрики продакшн-среды и автоматически расследует и устраняет аномалии.

## Обзор

```
┌──────────────┐     ┌───────────────┐     ┌──────────────┐     ┌──────────────┐
│  Метрики      │ ──▶ │  Обнаружение  │ ──▶ │  Анализ       │ ──▶ │  PR с        │
│  (Cloud Logs) │     │  аномалий     │     │  причин       │     │  исправлением│
│               │     │  (пороги)     │     │  (ИИ)         │     │  (авто)      │
└──────────────┘     └───────────────┘     └──────────────┘     └──────────────┘
```

## Включение

```yaml
repos:
  - name: my-repo
    workers:
      sre_agent:
        enabled: true
        gcloud_projects:
          - my-gcp-project-id
        error_threshold: 10        # Порог ошибок (/мин)
        latency_threshold_ms: 5000 # Порог задержки (мс)
        check_interval: 5m         # Интервал проверки
        cooldown_duration: 1h      # Задержка для предотвращения дубликатов
```

## Отслеживаемые метрики

### Частота ошибок
- Мониторинг частоты ошибок приложения
- Оповещение при превышении `error_threshold`

### Задержка
- Мониторинг времени отклика API
- Оповещение при превышении `latency_threshold_ms`

### Ресурсы
- Использование памяти (обнаружение OOM Kill)
- Загрузка CPU
- Использование диска

### Логи приложения
- Получение логов из GCP Cloud Logging
- Автоматический анализ стек-трейсов
- Обнаружение аномалий по паттернам

## Интеграция с GCP

SRE-агент интегрируется со следующими сервисами **Google Cloud Platform**:

| Сервис | Назначение |
|--------|------------|
| **Cloud Logging** | Получение логов приложения |
| **Cloud Monitoring** | Получение метрик |
| **Cloud Run** | Мониторинг контейнерных сред |

### Настройка аутентификации

```bash
# Установка GCP-проекта через переменные окружения
export GCP_PROJECT=my-project-id
export GOOGLE_CLOUD_PROJECT=my-project-id
```

> [!NOTE]
> Поддержка AWS и Azure запланирована в будущих релизах.

## Примеры авторемедиации

### 1. Всплеск ошибок

```
Обнаружено: Частота ошибок превышает 50/мин на /api/users
Анализ: NullPointerException в db.query()
Причина: Отсутствует проверка на null после нового деплоя
Исправление: Автоматически создан PR с добавлением проверки null
```

### 2. Утечка памяти (OOM)

```
Обнаружено: Контейнер перезапущен из-за OOM Kill
Анализ: Обнаружен паттерн избыточного создания объектов в логах
Причина: Кэш без ограничения размера
Исправление: Автоматически создан PR с ограничением LRU-кэша
```

### 3. Деградация задержки

```
Обнаружено: Задержка /api/search превышает 5000 мс
Анализ: Новый запрос без индекса
Причина: Индекс не создан при добавлении запроса по новой колонке
Исправление: Автоматически создан PR с миграцией индекса
```

## Оповещения

Оповещения SRE-агента интегрируются с системой уведомлений:

- **Slack** — Мгновенные уведомления в канал
- **Discord** — Webhook-уведомления
- **Email** — Письма с оповещениями

Подробности в [Настройки уведомлений](ru/guides/notifications.md).

## Доступность по планам

SRE-агент доступен на **плане Pro и выше**.

| План | SRE-агент |
|------|-----------|
| Free | ❌ |
| Pro | ✅ |
| Team | ✅ |
