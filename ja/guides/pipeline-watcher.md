# パイプライン監視 & 自動修復

Pipeline Watcher は CI/CD パイプラインの失敗を検知し、AI を使って修復コードを自動生成・プッシュします。

## 概要

```
┌──────────────┐     ┌───────────────┐     ┌──────────────┐     ┌──────────────┐
│  CI/CD        │ ──▶ │  原因分析      │ ──▶ │  修正コード    │ ──▶ │  プッシュ     │
│  失敗         │     │  （AI）        │     │  生成（AI）    │     │  （自動）     │
│  （検知）      │     │               │     │               │     │              │
└──────────────┘     └───────────────┘     └──────────────┘     └──────────────┘
```

## 有効化

```yaml
repos:
  - name: my-repo
    workers:
      pipeline_watcher:
        enabled: true
```

## 対応 CI/CD プラットフォーム

| プラットフォーム | 検知方法 |
|----------------|---------|
| **GitHub Actions** | Webhook / API ポーリング |
| **GitLab CI** | Webhook / API ポーリング |
| **CircleCI** | API ポーリング |
| **Jenkins** | Webhook |

## 検知するエラー種別

Pipeline Watcher は以下のエラーを自動分類し対処します：

### テスト失敗
- ユニットテストの失敗
- インテグレーションテストのタイムアウト
- E2E テストのアサーションエラー

### ビルドエラー
- コンパイルエラー
- 型エラー（TypeScript など）
- 依存関係の解決失敗

### Lint / フォーマット
- ESLint / Prettier エラー
- Go lint、Clippy（Rust）など

### セキュリティスキャン
- 脆弱な依存関係
- セキュリティルール違反

## 自動修復フロー

### 1. 失敗検知
Pipeline Watcher が Webhook またはポーリングで CI/CD の失敗を検知

### 2. ログ取得
失敗したジョブのログを自動取得し、エラーメッセージを抽出

### 3. AI 分析
エラーメッセージとソースコードを AI に渡し、原因を特定

### 4. 修正コード生成
AI が修復パッチを生成し、既存の PR に追加コミットとしてプッシュ

### 5. 結果検証
修正後の CI 結果を監視。成功ならクローズ、失敗なら再試行

## リトライ制限

無限ループ防止のため、自動修復のリトライ回数は制限されています：

| パラメータ | デフォルト | 説明 |
|-----------|----------|------|
| 最大リトライ回数 | 3 | PR あたりの修復試行回数 |
| クールダウン | 5 分 | リトライ間の待機時間 |

## ユースケース

### テスト失敗の自動修復

```
1. PR が作成される
2. GitHub Actions がテストを実行
3. 2 件のテストが失敗
4. Pipeline Watcher が失敗を検知
5. AI がテストログを分析
6. 修正コミットが自動プッシュ
7. テスト再実行 → 成功 ✅
```

### 依存関係エラーの修正

```
1. Dependabot が依存関係を更新
2. ビルドが壊れる
3. Pipeline Watcher が失敗を検知
4. AI が互換性をチェック
5. 互換性を保つようコードを更新
6. ビルド成功 ✅
```

> [!TIP]
> Pipeline Watcher は [Issue 自動処理](ja/guides/issue-automation.md) で作成された PR だけでなく、人が作成した PR の CI 失敗も監視します。
